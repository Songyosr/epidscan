# SatScan Pipeline User Guide

This guide provides step-by-step instructions for setting up and running the Leptospirosis SatScan Analysis Pipeline.

## Pipeline Overview

The pipeline orchestrates the flow of data from raw inputs to SatScan analysis and final visualization.

```{mermaid}
%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#E3F2FD', 'edgeLabelBackground':'#ffffff', 'tertiaryColor': '#fff', 'lineColor': '#333333'}}}%%
graph TD
    subgraph Orchestrator ["run_pipeline.R"]
        style Orchestrator fill:#f9f9f9,stroke:#333,stroke-width:2px
        Start([Start Pipeline]) --> CheckGeo{Update Geo?}
        style Start fill:#4CAF50,stroke:#333,stroke-width:2px,color:white
        
        %% Geo Logic
        CheckGeo -- Yes --> P_Geo
        CheckGeo -- No --> CheckGeoExist{Geo Exists?}
        CheckGeoExist -- No --> P_Geo
        CheckGeoExist -- Yes --> CheckPop
        
        P_Geo[("process_geo.R")] --> CheckPop{Update Pop?}
        
        %% Pop Logic
        CheckPop -- Yes --> P_Pop
        CheckPop -- No --> CheckPopExist{Pop Exists?}
        CheckPopExist -- No --> P_Pop
        CheckPopExist -- Yes --> CheckCases
        
        P_Pop[("process_population.R")] --> CheckCases{Update Cases?}
        
        %% Case Logic
        CheckCases -- Yes --> P_Cases
        CheckCases -- No --> RunSS
        
        P_Cases[("process_cases.R")] --> RunSS
        
        %% SatScan Execution
        RunSS[("run_satscan.R")] 
        
        %% Data Dependencies (dashed to separate from control flow)
        P_Geo -.->|Creates| GeoFile([satscan.geo])
        P_Geo -.->|Creates| GeoRDS([geo_lookup.rds])
        
        P_Pop -.->|Creates| PopFile([satscan.pop])
        P_Pop -.->|Creates| PopRDS([pop_aggregate.rds])
        
        P_Cases -.->|Creates| CasFile([satscan.cas])
        P_Cases -.->|Creates| CasRDS([cases_aggregate.rds])
        
        CasFile -.->|Input| RunSS
        PopFile -.->|Input| RunSS
        GeoFile -.->|Input| RunSS
        
        RunSS -->|Prepares & Executes| SatScanApp[[SaTScan Application]]
        
        SatScanApp -->|Outputs| SSRes([satscan_results.rds])
        SatScanApp -->|Outputs| SSClus([clusters.csv])
        
        %% Post Processing
        SSRes --> PostProc
        GeoRDS --> PostProc
        
        PostProc[("post_process.R")] -->|Merges| FinalOut([results_sf.rds])
        
        FinalOut --> End([End Pipeline])
    end

    subgraph Inputs
        style Inputs fill:#FFF3E0,stroke:#FF9800,stroke-width:2px
        Shp[Shapefile] --> P_Geo
        style Shp fill:#FFCC80,stroke:#E65100,stroke-width:1px,color:black
        PopCache[Population Cache] --> P_Pop
        style PopCache fill:#FFCC80,stroke:#E65100,stroke-width:1px,color:black
        CaseFile[Case Data File] --> P_Cases
        style CaseFile fill:#FFCC80,stroke:#E65100,stroke-width:1px,color:black
    end
    
    classDef file fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    class GeoFile,GeoRDS,PopFile,PopRDS,CasFile,CasRDS,SSRes,SSClus,FinalOut file;
```

### Key Components
1.  **Orchestrator (`run_pipeline.R`)**: The main script that manages the workflow. It checks if data needs updating and calls the appropriate modules.
2.  **Modules (`R/modules/`)**: Specialized scripts for each step:
    *   `process_geo.R`: Prepares shapefiles and centroids.
    *   `process_population.R`: Aggregates population data from cache.
    *   `process_cases.R`: Cleans and formats case data.
    *   `run_satscan.R`: Executes the SatScan engine in a temporary sandbox.
    *   `post_process.R`: Merges results back into a map-ready format.


## 1. System Requirements

### Software
1.  **R (v4.0+)**: [Download R](https://cran.r-project.org/)
2.  **RStudio** (Recommended): [Download RStudio](https://posit.co/download/rstudio-desktop/)
3.  **SaTScan (v10.0+)**: [Download SaTScan](https://www.satscan.org/)
    *   *Note*: You must register on the SaTScan website to download the software.

### R Packages
The pipeline requires the following R packages. Run this command in R to install them:

```r
install.packages(c("tidyverse", "sf", "rsatscan", "leaflet", "rmarkdown", "htmltools", "kableExtra"))
```

## 2. Installation & Setup

1.  **Unzip the Package**: Extract the `lepto_satscan_pipeline.zip` file to a folder on your server or local machine.
2.  **Verify Environment**: Open `lepto.Rproj` (if available) or set your working directory to the extracted folder.
3.  **Run Check**: Open and run `check_installation.R`.
    *   This script will verify that R packages are installed, find the SatScan executable, and ensure necessary data files are present.
    *   If it fails to find SatScan, you may need to manually specify the path in `run_pipeline.R`.

## 3. Data Preparation

The pipeline expects two main input files. You must place these in the `data/` folder (or point to them in the script).

### A. Case Data (`.rds`, `.csv`, or `.xlsx`)
Must contain a line list of cases.
*   **Required Columns**:
    *   `date`: Date of onset (YYYY-MM-DD).
    *   `location_id`: The 6-digit Tambon code (e.g., "900101").
    *   *(Optional)* `age`: Age in years (for stratified analysis).
    *   *(Optional)* `sex`: Sex (Male/Female) (for stratified analysis).

### B. Population Data
The pipeline uses a population cache. If you are running this offline, ensure the `data/population_cache` folder is populated.

## 4. Running the Analysis

The main entry point is `run_pipeline.R`.

### Step 1: Configure
Open `run_pipeline.R` and adjust the parameters in the `run_pipeline()` function call:

```r
run_pipeline(
  mode = "simple",           # "simple" (Total counts) or "stratified" (Age/Sex adj)
  shapefile_path = "data/thai_bound/tha_admbnda_adm3_rtsd_20220121.shp",
  province_code = "90",      # Filter for Songkhla (or NULL for all)
  
  # Case Data
  case_file = "data/my_cases.rds",
  start_date = "2025-01-01",
  end_date = "2025-12-31",
  
  # Analysis Settings
  run_analysis = TRUE
)
```

### Step 2: Execute
Select the code block and run it (Ctrl+Enter / Cmd+Enter).
The pipeline will:
1.  Process Geographic Data
2.  Process Population Data
3.  Process Case Data
4.  Run SatScan
5.  Post-process results into a map-ready format.

### Step 3: Check Outputs
Results are saved in `data/derived/`:
*   `results_sf.rds`: An R spatial object containing the map and cluster results.
*   `satscan_results/`: Contains raw SatScan output files (`.col`, `.gis`, `.rr`).

## 5. Visualization

To view the results interactively:
1.  Open `visualize_results.Rmd`.
2.  Click the **Knit** button in RStudio.
3.  This will generate an HTML report (`visualize_results.html`) with interactive maps and cluster summaries.

## 6. Advanced Configuration

### Using a Custom SatScan Parameter File
If you need advanced SatScan settings (e.g., covariates, specific cluster sizes), you can use the SatScan GUI to generate a `.prm` file.

1.  Open SaTScan GUI.
2.  Set your parameters.
3.  File -> Save Parameter File As... -> `my_config.prm`.
4.  Pass this file to the pipeline:

```r
run_pipeline(
  ...,
  satscan_config = "my_config.prm"
)
```

## Troubleshooting

*   **"SatScan executable not found"**:
    *   Edit `R/modules/run_satscan.R` and add your specific path to the `satscan_exe_paths` list.
*   **"Shapefile not found"**:
    *   Ensure the `data/thai_bound` folder contains all shapefile components (`.shp`, `.shx`, `.dbf`, etc.).
