---
title: "Leptospirosis SatScan Analysis"
output: html_document
---

# Load Libraries
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(sf)
library(rsatscan)
library(leaflet)
library(htmltools)
```

# Load Data
```{r}
# Load the prepared case data
case_data <- read.table("data/satscan_case.cas", col.names = c("location_id", "cases", "date"))
pop_data <- read.table("data/satscan_pop.pop", col.names = c("location_id", "year", "pop"))
geo_data <- read.table("data/satscan_geo.geo", col.names = c("location_id", "lat", "long"))


```

# Data Preparation
```{r}
# Create temporary directory
td <- tempdir()

# Prepare case data with proper format
case <- case_data |> select(location_id, cases, date) |> 
  filter(date >="2025/01/01" & date <= "2025/11/30")
write.cas(case, td, "lepto") 

# Prepare population data
pop <- pop_data |> select(location_id, year, pop)
write.pop(pop, td, "lepto")

# Prepare coordinates
coordinates <- geo_data |> select(location_id, lat, long)
write.geo(coordinates, td, "lepto")
```

# Configure SatScan Parameters
```{r message=FALSE, warning=FALSE}
# Ensure rsatscan is loaded
if(!require("rsatscan", quietly = TRUE)) {
  library(rsatscan)
}
ss.options(reset = TRUE) |> invisible()

ss.options(list(
  # [Input]
  CaseFile = "lepto.cas",
  PopulationFile = "lepto.pop",
  CoordinatesFile = "lepto.geo",
  PrecisionCaseTimes = 3,              # Day precision
  StartDate = "2025/01/01",
  EndDate = "2025/11/30",
  CoordinatesType = 1,                 # Lat/Long
  
  # [Analysis]
  AnalysisType = 4,                    # Prospective Space-Time
  ModelType = 0,                       # Discrete Poisson
  ScanAreas = 1,                       # High Rates
  TimeAggregationUnits = 3,            # Day
  TimeAggregationLength = 1,
  
  # [Spatial/Temporal]
  MaxSpatialSizeInPopulationAtRisk = 25,  # Reduced from 50 for smaller clusters
  MaxTemporalSize = 30,
  
  # [Output]
  ReportGiniClusters = "n",
  LogRunToHistoryFile = "n"
))

write.ss.prm(td, "lepto")
```

# Run SatScan Analysis
```{r}
lepto_results <- satscan(td, "lepto", 
                         sslocation = "/Applications/SaTScan.app/Contents/app", 
                         ssbatchfilename = "satscan", 
                         cleanup = FALSE, 
                         verbose = FALSE)

print(summary(lepto_results))
```

# Extract Cluster Results
```{r}
# Get cluster information
if(!is.null(lepto_results$col) && nrow(lepto_results$col) > 0) {
  clusters <- lepto_results$col |>
    mutate(
      significant = P_VALUE < 0.05
    )
  
  print(paste("Total clusters detected:", nrow(clusters)))
  print(paste("Significant clusters (p < 0.05):", sum(clusters$significant)))
  
  # Display cluster summary
  clusters |>
    filter(significant) |>
    select(CLUSTER, NUMBER_LOC, RADIUS, START_DATE, END_DATE, 
           OBSERVED, EXPECTED, REL_RISK, P_VALUE) |>
    arrange(P_VALUE) |>
    print()
} else {
  print("No clusters detected")
  clusters <- data.frame()
}
```

# Visualization: Interactive Map

# Visualization: Interactive Maps

## Prepare Data for Visualization
```{r}
# Load shapefile for visualization
shp <- st_read("data/thai_bound/tha_admbnda_adm3_rtsd_20220121.shp", quiet = TRUE) |>
  filter(ADM1_PCODE == "TH90") |>  # Songkhla
  mutate(tambon_code = gsub("^TH", "", ADM3_PCODE)) |> # remove the prefix "TH"
  select(tambon_code, ADM3_EN, ADM3_TH, ADM2_TH, ADM1_TH, geometry)

if(nrow(clusters) > 0 && !is.null(lepto_results$gis)) {
  # Get tambon-level relative risk from rr data
  tambon_rr <- lepto_results$rr |>
    select(LOC_ID, OBSERVED, EXPECTED, REL_RISK) |>
    rename(
      TAMBON_OBS = OBSERVED,
      TAMBON_EXP = EXPECTED,
      TAMBON_RR = REL_RISK
    )
  
  # Get cluster-level data with span
  cluster_info <- clusters |>
    select(CLUSTER, REL_RISK, significant, SPAN, START_DATE, END_DATE) |>
    rename(CLUSTER_RR = REL_RISK)
  
  # Get cluster locations
  cluster_locs <- lepto_results$gis |>
    left_join(cluster_info, by = "CLUSTER") |>
    filter(!is.na(P_VALUE))
  
  # Join with shapefile
  map_data <- shp |>
    mutate(location_id = as.character(tambon_code)) |>
    left_join(cluster_locs |> 
                select(LOC_ID, CLUSTER, CLUSTER_RR, LOC_RR, LOC_OBS, P_VALUE, 
                       significant, SPAN, START_DATE, END_DATE), 
              by = c("location_id" = "LOC_ID")) |>
    left_join(tambon_rr, by = c("location_id" = "LOC_ID")) |>
    mutate(
      in_cluster = !is.na(CLUSTER),
      cluster_sig = ifelse(is.na(significant), NA, significant)
    )
  
  # Get cluster boundaries for polygon overlays
  cluster_boundaries <- map_data |>
    filter(in_cluster) |>
    group_by(CLUSTER) |>
    summarise(
      geometry = st_union(geometry),
      significant = first(significant),
      CLUSTER_RR = first(CLUSTER_RR),
      SPAN = first(SPAN),
      START_DATE = first(START_DATE),
      END_DATE = first(END_DATE),
      .groups = "drop"
    )
  
  print(paste("Map data prepared with", nrow(map_data), "tambons"))
  print(paste("Cluster boundaries:", nrow(cluster_boundaries), "clusters"))
  
  # Create province border
  province_border <- shp |>
    summarise(geometry = st_union(geometry))
}
```

## Map 1: Homogenous Cluster Risk (Average RR)
```{r}
if(exists("map_data")) {
  # Create log-transformed diverging color palette
  # Use CLUSTER_RR which is the same for all locations in a cluster
  map_data_vis <- map_data |>
    mutate(
      # Use CLUSTER_RR for cluster areas
      display_rr = ifelse(in_cluster, CLUSTER_RR, NA),
      log_display_rr = log(pmax(display_rr, 0.01, na.rm = TRUE))
    )
  
  # Determine symmetric range around 0
  rr_range <- max(abs(map_data_vis$log_display_rr), na.rm = TRUE)
  
  pal_cluster <- colorNumeric(
    palette = colorRampPalette(c("#2166AC", "#D1E5F0", "#FFFFFF", "#FDDBC7", "#B2182B"))(100),
    domain = c(-rr_range, rr_range),
    na.color = "#E8E8E8"
  )
  
  # Create map
  map1 <- leaflet(map_data_vis) |>
    addProviderTiles(providers$CartoDB.Positron) |>
    addPolygons(
      fillColor = ~pal_cluster(log_display_rr),
      fillOpacity = ~ifelse(in_cluster, 0.7, 0.1), # Very faint for non-cluster
      color = "#999999",  # Add thin gray border
      weight = 0.5,       # Thin border
      popup = ~paste0(
        "<b>", ADM3_EN, "</b> (", tambon_code, ")<br/>",
        "ต.", ADM3_TH, " อ.", ADM2_TH, " จ.", ADM1_TH, "<br/>",
        "<hr>",
        ifelse(in_cluster,
               paste0(
                 "<b>Cluster ", CLUSTER, "</b>",
                 ifelse(significant, " ⭐ <i>(Significant)</i>", " <i>(Not significant)</i>"), "<br/>",
                 "<b>Cluster Avg Relative Risk: ", round(CLUSTER_RR, 2), "</b><br/>",
                 "Time Span: ", round(SPAN, 1), " days<br/>",
                 "Period: ", START_DATE, " to ", END_DATE, "<br/>",
                 "P-value: ", format(P_VALUE, digits = 3)
               ),
               "Not in any cluster"
        )
      )
    )
  
  # Add cluster boundary outlines
  if(exists("cluster_boundaries")) {
    map1 <- map1 |>
      addPolygons(
        data = cluster_boundaries,
        fillColor = "transparent",
        color = ~ifelse(significant, "#D32F2F", "#808080"),
        weight = 3,
        opacity = ~ifelse(significant, 0.9, 0.5),
        popup = ~paste0(
          "<b>Cluster ", CLUSTER, "</b><br/>",
          "Avg Relative Risk: ", round(CLUSTER_RR, 2), "<br/>",
          "Time Span: ", round(SPAN, 1), " days<br/>",
          "Period: ", START_DATE, " to ", END_DATE
        )
      )
  }
  
  # Add province border (unclickable)
  if(exists("province_border")) {
    map1 <- map1 |>
      addPolylines(
        data = province_border,
        color = "black",
        weight = 2,
        opacity = 1,
        fill = FALSE#,
        #interactive = FALSE
      )
  }
  
  # Add legend with RR values
  legend_vals <- c(0.25, 0.5, 1, 2, 4, 8, 16)
  legend_colors <- sapply(log(legend_vals), function(x) pal_cluster(x))
  
  map1 <- map1 |>
    addLegend(
      colors = legend_colors,
      labels = legend_vals,
      title = "Cluster Average<br/>Relative Risk<br/>",
      position = "bottomright",
      opacity = 1
    )
  
  print("### Map 1: Homogenous Cluster Relative Risk (Average RR)")
  map1
}
```

## Map 2: Heterogenous Local Risk (Location RR)
```{r}
if(exists("map_data")) {
  # Use LOC_RR for local risk, only for those in cluster
  if(!exists("map_data_vis_2")) {
    map_data_vis_2 <- map_data |>
      mutate(
        # Use LOC_RR for cluster areas, NA for others
        # Treat LOC_OBS=0 (no cases) as NA for visualization so it gets the NA color (gray)
        display_rr = ifelse(in_cluster & LOC_OBS > 0, LOC_RR, NA),
        log_display_rr = log(display_rr)#log(pmax(display_rr, 0.01, na.rm = TRUE))
      )
  }
  
  # Determine symmetric range around 0 for local RR
  rr_range_local <- max(abs(map_data_vis_2$log_display_rr), na.rm = TRUE)
  
  pal_local <- colorNumeric(
    palette = colorRampPalette(c("#2166AC", "#D1E5F0", "#FFFFFF", "#FDDBC7", "#B2182B"))(100),
    domain = c(-rr_range_local, rr_range_local),
    na.color = "#E8E8E8"
  )
  
  # Create map
  map2 <- leaflet(map_data_vis_2) |>
    addProviderTiles(providers$CartoDB.Positron) |>
    addPolygons(
      fillColor = ~pal_local(log_display_rr),
      fillOpacity = ~ifelse(in_cluster, 0.7, 0.1), # Faint for non-cluster
      color = "#999999",  # Add thin gray border
      weight = 0.5,       # Thin border
      popup = ~paste0(
        "<b>", ADM3_EN, "</b> (", tambon_code, ")<br/>",
        "ต.", ADM3_TH, " อ.", ADM2_TH, " จ.", ADM1_TH, "<br/>",
        "<hr>",
        ifelse(in_cluster,
               paste0(
                 "<b>Cluster ", CLUSTER, "</b>",
                 ifelse(significant, " ⭐ <i>(Significant)</i>", " <i>(Not significant)</i>"), "<br/>",
                 "<b>Cluster Avg Relative Risk: ", round(CLUSTER_RR, 2), "</b><br/>",
                 "Time Span: ", round(SPAN, 1), " days<br/>",
                 "Period: ", START_DATE, " to ", END_DATE, "<br/>",
                 "<hr>",
                 "Local Relative Risk: ", round(LOC_RR, 2), "<br/>",
                 "P-value: ", format(P_VALUE, digits = 3)
               ),
               "Not in any cluster"
        )
      )
    )
  
  # Add cluster boundary outlines
  if(exists("cluster_boundaries")) {
    map2 <- map2 |>
      addPolylines(
        data = cluster_boundaries,
        color = ~ifelse(significant, "#D32F2F", "#808080"),
        weight = 3,
        opacity = ~ifelse(significant, 0.9, 0.5)
      )
  }
  
  # Add province border (unclickable)
  if(exists("province_border")) {
    map2 <- map2 |>
      addPolylines(
        data = province_border,
        color = "black",
        weight = 2,
        opacity = 1,
        fill = FALSE#,
        #interactive = FALSE
      )
  }
  
  # Add legend with RR values
  legend_vals <- c(0.25, 0.5, 1, 2, 4, 8, 16)
  legend_colors <- sapply(log(legend_vals), function(x) pal_local(x))
  
  map2 <- map2 |>
    addLegend(
      colors = legend_colors,
      labels = legend_vals,
      title = "Local Outbreak<br/>Relative Risk<br/>",
      position = "bottomright",
      opacity = 1
    )
  
  print("### Map 2: Heterogenous Local Relative Risk (Location RR)")
  map2
}
```

```{r}
if(!exists("map_data")) {
  print("No clusters to visualize")
}
```

# Summary Report
```{r echo=FALSE, results='asis'}
cat("# Leptospirosis Cluster Analysis Report\n\n")
cat("**Analysis Period:** ", min(case_data$date), " to ", max(case_data$date), "\n\n")
cat("**Analysis Type:** Prospective Space-Time Poisson\n\n")

if(nrow(clusters) > 0) {
  sig_clusters <- clusters |> filter(significant)
  
  cat("## Key Findings\n\n")
  cat("- **Total clusters detected:** ", nrow(clusters), "\n")
  cat("- **Significant clusters (p < 0.05):** ", nrow(sig_clusters), "\n")
  
  if(nrow(sig_clusters) > 0) {
    cat("\n## Most Significant Cluster\n\n")
    top_cluster <- sig_clusters |> arrange(P_VALUE) |> slice(1)
    
    cat("- **Cluster ID:** ", top_cluster$CLUSTER, "\n")
    cat("- **Number of locations:** ", top_cluster$NUMBER_LOC, "\n")
    cat("- **Radius:** ", round(top_cluster$RADIUS, 2), " km\n")
    cat("- **Time period:** ", top_cluster$START_DATE, " to ", top_cluster$END_DATE, "\n")
    cat("- **Observed cases:** ", top_cluster$OBSERVED, "\n")
    cat("- **Expected cases:** ", round(top_cluster$EXPECTED, 2), "\n")
    cat("- **Relative Risk:** ", round(top_cluster$REL_RISK, 2), "\n")
    cat("- **P-value:** ", format(top_cluster$P_VALUE, scientific = TRUE), "\n")
    
    cat("\n## All Significant Clusters\n\n")
    cat("```\n")
    sig_clusters |>
      select(CLUSTER, NUMBER_LOC, RADIUS, OBSERVED, EXPECTED, REL_RISK, P_VALUE) |>
      print()
    cat("```\n")
  }
} else {
  cat("## Key Findings\n\n")
  cat("No significant clusters were detected during the analysis period.\n")
}
```
